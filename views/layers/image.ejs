<% function getStyles (settings) {
  let styles = ''
  if (settings) {
    if (settings.margin) {
      if (['1', '4', '7', '10', '13'].some(position => position === settings.position)) {
        styles += `left: ${settings.margin}px; `
      } else if (['3', '6', '9', '12', '15'].some(position => position === settings.position)) {
        styles += `right: ${settings.margin}px; `
      }
      styles += `top: ${settings.margin}px; `
      styles += `bottom: ${settings.margin}px; `
    }
    if (settings.opacity > 0) {
      styles += `opacity: ${settings.opacity / 100}; `
    }
    // if (settings.shadow > 0) {
    //   styles += `filter: drop-shadow(0px 0px ${settings.shadow}px 0px rgba(0,0,0,0.75);`
    // }
    if (settings.rotate >= 0 && layer.settings.layerSettings.fullscreen) {
      var dist = Math.sqrt((Math.pow(layer.iframeWidth, 2) || Math.pow(400, 2)) + (Math.pow(layer.iframeHeight, 2) || Math.pow(711, 2)));
      var diagAngle = Math.asin((layer.iframeHeight || 711) / dist);

      var a1 = (((settings.rotate * Math.PI / 180) % (Math.PI * 2)) + Math.PI * 4) % (Math.PI * 2);
      console.log('a1', a1)
      if (a1 > Math.PI) {
        a1 -= Math.PI;
      }
      if (a1 > Math.PI / 2 && a1 <= Math.PI) {
        a1 = (Math.PI / 2) - (a1 - (Math.PI / 2));
      }

      var ang1 = Math.PI / 2 - diagAngle - Math.abs(a1)
      var ang2 = Math.abs(diagAngle - Math.abs(a1))

      var scale1 = Math.cos(ang1) * dist / layer.settings.layerSettings.height
      var scale2 = Math.cos(ang2) * dist / layer.settings.layerSettings.width
      console.log('Math.PI / 2 - diagAngle - Math.abs(a1)', Math.PI / 2 - diagAngle - Math.abs(a1))

      var scale = Math.max(scale1, scale2)
      styles += `transform: rotate(${settings.rotate}deg) scale(${scale + 0.05});`
    }
    if (settings.rotate >= 0 && !layer.settings.layerSettings.fullscreen) {
      styles += `transform: rotate(${settings.rotate}deg);`
    }
    styles += `z-index: ${layer.position}`
  }
  return styles
}
function getImageUrl (content) {
  console.log('content', content)
  if (layer.type === 'video') {
    if (content.thumbnail !== '') {
      console.log('thumbnail')
      return content.thumbnail || content.image.thumbnail
    } else if (content.image.thumbnail) {
      return content.image.thumbnail || ''
    } else {
      return ''
    }
  } else {
    return content.value || ''
  }
}
if (layer.settings.layerSettings.fullscreen){ %>
<div
  <% if (layer.settings.generalSettings.rotate >= '1' && layer.settings.generalSettings.rotate !== '360'){ %>
  class="image flex-container position<%= layer.settings.generalSettings.position %>"
  style="<%= getStyles(layer.settings.generalSettings) %>; overflow: hidden; "
  <% } else { %>
  class="image-full flex-container-full position<%= layer.settings.generalSettings.position %>"
  style="<%= getStyles(layer.settings.generalSettings) %>; transform: none;"
  <% } %>
>
  <amp-img
    src="<%= getImageUrl(layer.content) %>"
    <% if (layer.settings.generalSettings.rotate < '1' || layer.settings.generalSettings.rotate == '360' ) { %>
    width='100'
    height='100'
    layout="responsive"
    class="amp-img-full"
    <% } else { %>
    width="<%= layer.settings.layerSettings.width %>px"
    height="<%= layer.settings.layerSettings.height %>px"
    class=""
    layout="fixed"
    <% } %>

    alt="an image"
    <% if (layer.settings.animateIn && !preview){ %>
    animate-in="<%= layer.settings.animateIn %>"
    <% } %>
    <% if (layer.settings.animateDuration){ %>
    animate-in-duration="<%= layer.settings.animateDuration %>"
    <% } %>
    <% if (layer.settings.generalSettings.rotate >= '1' && layer.settings.generalSettings.rotate !== '360'){ %>
    <% } %>
  >
  </amp-img>
</div>
<% } else { %>
<div
  class="image flex-container position<%= layer.settings.generalSettings.position %>"
  style="<%= getStyles(layer.settings.generalSettings); %>"
  <% if (layer.settings.animateIn && !preview){ %>
  animate-in="<%= layer.settings.animateIn %>"
  <% } %>
  <% if (layer.settings.animateDuration){ %>
  animate-in-duration="<%= layer.settings.animateDuration %>s"
  <% } %>
>
  <amp-img
    src="<%= getImageUrl(layer.content) %>"
    width="<%= layer.settings.layerSettings.width %>"
    height="<%= layer.settings.layerSettings.height %>"
    layout="fixed"
    alt="an image"
    style="position: absolute; transform: translate(-50%, -50%); filter: drop-shadow(0px 0px <%= layer.settings.generalSettings.shadow %>px rgba(0,0,0,0.75));"
  ></amp-img>
</div>
<% } %>
